{% extends "layout.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- URL Input and Progress Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <!-- Input Panel -->
        <div class="bg-zinc-50 shadow-md rounded px-8 pt-6 pb-8 mb-4 min-h-80">
            <h2 class="text-xl text-zinc-700 font-bold mb-4">Analyze Content</h2>
            <p class="pb-4">Enter a YouTube URL to generate an analysis. Works with channels and videos.</p>
            <p class="pb-4">Reports can take a minute to generate ☺️</p>
            <form id="content-form" class="space-y-4">
                <div>
                    <!-- label for="content-url" class="block text-zinc-700 text-sm mb-2">YouTube URL:</label -->
                    <input type="text" id="content-url" name="content-url" required 
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                           placeholder="https://youtube.com/...">
                </div>
                <button type="submit" class="bg-red-500 hover:bg-red-700 text-zinc-50 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                    Analyze Content
                </button>
            </form>
        </div>

        <!-- Progress Display Panel -->
        <div class="relative bg-zinc-800 text-green-500 min-h-80 font-mono text-sm shadow-md rounded px-4 pt-4 pb-4 mb-4 h-64 overflow-y-auto">
            <div class="grain absolute inset-0 opacity-50 mix-blend-multiply"></div>
            <h2 class="text-xl font-bold mb-4 text-zinc-50">Progress Log</h2>
            <div id="progress-log">
                > Waiting for YouTube URL to begin ...
            </div>
        </div>
    </div>

    <!-- Reports Section Header -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl text-zinc-800 font-bold">Your Reports</h1>
        <div class="flex items-center space-x-4">
            <span class="text-zinc-600">View:</span>
            <button id="grid-view" class="px-3 py-1 bg-red-500 text-white rounded-l-md">Grid</button>
            <button id="list-view" class="px-3 py-1 bg-zinc-300 text-zinc-700 rounded-r-md">List</button>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="mb-6 flex justify-between items-center">
        <div class="space-x-2">
            <button class="bg-red-500 text-white px-4 py-2 rounded" onclick="filterReports('all')">All</button>
            <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="filterReports('channel')">Channel Reports</button>
            <button class="bg-green-500 text-white px-4 py-2 rounded" onclick="filterReports('video')">Video Summaries</button>
        </div>
        <div>
            <input type="text" id="search-input" placeholder="Search reports..." class="border rounded px-4 py-2">
        </div>
    </div>

    <!-- Grid View -->
    <div id="grid-view-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for item in combined_data %}
            <div class="report-card bg-white shadow-md rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-300 {% if item.type == 'channel_report' %}channel-report{% else %}video-summary{% endif %} cursor-pointer" 
                 style="aspect-ratio: 16/9;" 
                 data-id="{{ item.item.id }}">
                {% if item.type == 'channel_report' %}
                    {% set raw_data = item.item.raw_channel_data | from_json %}
                    <div class="relative h-full bg-cover bg-center" style="background-image: url('{{ raw_data.banner_url }}=w2120-fcrop64=1,00005a57ffffa5a8-k-c0xffffffff-no-nd-rj');">
                        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                        <div class="absolute inset-0 p-4 flex flex-col justify-between">
                            <div class="flex items-center">
                                <img src="{{ raw_data.avatar_url }}" alt="{{ item.item.channel_title }} avatar" class="w-10 h-10 rounded-full mr-3">
                                <h3 class="text-lg font-semibold text-white truncate">{{ item.item.channel_title }}</h3>
                            </div>
                            <div>
                                <p class="text-sm text-zinc-200 mb-2">Generated: {{ item.date_created.strftime('%Y-%m-%d %I:%M %p') }}</p>
                                <button onclick="viewReport('{{ item.type }}', '{{ item.item.id }}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full transition-colors duration-300">
                                    View Report
                                </button>
                            </div>
                        </div>
                    </div>
                {% else %}
                    {% set raw_data = item.item.raw_video_data | from_json %}
                    {% set high_res_thumbnail = raw_data.thumbnail_url | replace("default.jpg", "maxresdefault.jpg") %}
                    <div class="relative h-full bg-cover bg-center" style="background-image: url('{{ high_res_thumbnail }}');">
                        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                        <div class="absolute inset-0 p-4 flex flex-col justify-between">
                            <h3 class="text-lg font-semibold text-white truncate">{{ item.item.video_title }}</h3>
                            <div>
                                <p class="text-sm text-zinc-200 mb-2">Generated: {{ item.date_created.strftime('%Y-%m-%d %I:%M %p') }}</p>
                                <button onclick="viewReport('{{ item.type }}', '{{ item.item.id }}')" 
                                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded w-full transition-colors duration-300">
                                    View Summary
                                </button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <!-- List View -->
    <div id="list-view-container" class="hidden space-y-4">
        {% for item in combined_data %}
        <div class="report-item bg-white shadow-md rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-300 {% if item.type == 'channel_report' %}channel-report{% else %}video-summary{% endif %}">
            <div class="p-4 flex justify-between items-center">
                <div class="flex items-center">
                    {% if item.type == 'channel_report' %}
                        {% set raw_data = item.item.raw_channel_data | from_json %}
                        <img src="{{ raw_data.avatar_url }}" alt="{{ item.item.channel_title }} avatar" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <h3 class="text-lg font-semibold text-zinc-800">{{ item.item.channel_title }}</h3>
                            <p class="text-sm text-zinc-600">Generated: {{ item.date_created.strftime('%Y-%m-%d %I:%M %p') }}</p>
                        </div>
                    {% else %}
                        {% set raw_data = item.item.raw_video_data | from_json %}
                        {% set high_res_thumbnail = raw_data.thumbnail_url | replace("default.jpg", "maxresdefault.jpg") %}
                        <img src="{{ high_res_thumbnail }}" alt="{{ item.item.video_title }} thumbnail" class="w-32 h-18 object-cover rounded mr-3">
                        <div>
                            <h3 class="text-lg font-semibold text-zinc-800">{{ item.item.video_title }}</h3>
                            <p class="text-sm text-zinc-600">Generated: {{ item.date_created.strftime('%Y-%m-%d %I:%M %p') }}</p>
                        </div>
                    {% endif %}
                </div>
                <button onclick="viewReport('{{ item.type }}', '{{ item.item.id }}')" 
                        class="{% if item.type == 'channel_report' %}bg-blue-500 hover:bg-blue-600{% else %}bg-green-500 hover:bg-green-600{% endif %} text-white font-bold py-2 px-4 rounded transition-colors duration-300">
                    View {{ 'Report' if item.type == 'channel_report' else 'Summary' }}
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Report/Summary Modal -->
    <div id="report-modal" class="modal-overlay fixed inset-0 bg-zinc-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
        <div class="modal-container relative top-20 mx-auto p-5 border w-11/12 xl:w-3/4 2xl:w-2/3 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="mt-2 px-7 py-3">
                    <div id="modal-content" class="text-left"></div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

// Global state
let messageQueue = [];
let isTyping = false;

// Initialize all components when document is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing dashboard components...');
    initializeContentForm();
    initializeViewToggles();
    initializeSearchAndFilters();
    initializeModal();
    initializeReportCards();
    openNewItemModal();
});

function initializeContentForm() {
    console.log('Initializing content form');
    const form = document.getElementById('content-form');
    const progressLog = document.getElementById('progress-log');
    
    if (!form || !progressLog) {
        console.error('Required elements not found');
        return;
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submitted');
        
        const url = document.getElementById('content-url').value;
        console.log('Processing URL:', url);
        
        // Clear previous messages
        progressLog.innerHTML = '';
        messageQueue = [];
        addToMessageQueue('Starting analysis ');

        try {
            const response = await fetch('/process_url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({url: url})
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const {done, value} = await reader.read();
                
                if (done) {
                    console.log('Stream complete');
                    if (buffer) {
                        processChunk(buffer);
                    }
                    break;
                }

                buffer += decoder.decode(value, {stream: true});
                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.trim()) {
                        processChunk(line);
                    }
                }
            }
        } catch (error) {
            console.error('Error:', error);
            addToMessageQueue(`Error: ${error.message}`);
        }
    });
}

function processChunk(line) {
    try {
        const data = JSON.parse(line);
        console.log('Received data:', data);

        switch (data.type) {
            case 'progress':
                addToMessageQueue(data.message);
                break;
            case 'error':
                addToMessageQueue(`Error: ${data.message}`);
                break;
            case 'complete':
                addToMessageQueue('Analysis complete. Redirecting ');
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1500);
                break;
            default:
                console.log('Unknown message type:', data.type);
        }
    } catch (e) {
        console.error('Error parsing JSON:', e);
        console.error('Problematic line:', line);
    }
}

function addToMessageQueue(message) {
    console.log('Adding message to queue:', message);
    messageQueue.push(message);
    if (!isTyping) {
        typeNextMessage();
    }
}

function typeNextMessage() {
    if (messageQueue.length === 0) {
        isTyping = false;
        return;
    }

    isTyping = true;
    const message = messageQueue.shift();
    
    // Remove 'active' class from any previous entries
    document.querySelectorAll('.log-entry').forEach(entry => {
        entry.classList.remove('active');
    });
    
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry active'; // Add 'active' class here
    logEntry.innerHTML = `> <span class="vidiprinter"></span>`;
    document.getElementById('progress-log').appendChild(logEntry);
    
    typeVidiprinter(logEntry.querySelector('.vidiprinter'), message, () => {
        document.getElementById('progress-log').scrollTop = document.getElementById('progress-log').scrollHeight;
        // If this is the last message, keep it active
        if (messageQueue.length > 0) {
            logEntry.classList.remove('active');
        }
        setTimeout(typeNextMessage, 50);
    });
}

function typeVidiprinter(element, text, onComplete, index = 0) {
    if (index < text.length) {
        element.textContent += text[index];
        setTimeout(() => typeVidiprinter(element, text, onComplete, index + 1), 10);
    } else {
        onComplete();
    }
}

function initializeViewToggles() {
    console.log('Initializing view toggles');
    const gridViewBtn = document.getElementById('grid-view');
    const listViewBtn = document.getElementById('list-view');
    const gridViewContainer = document.getElementById('grid-view-container');
    const listViewContainer = document.getElementById('list-view-container');

    if (!gridViewBtn || !listViewBtn || !gridViewContainer || !listViewContainer) {
        console.error('View toggle elements not found');
        return;
    }

    gridViewBtn.addEventListener('click', () => {
        gridViewBtn.classList.remove('bg-zinc-300', 'text-zinc-700');
        gridViewBtn.classList.add('bg-red-500', 'text-white');
        listViewBtn.classList.remove('bg-red-500', 'text-white');
        listViewBtn.classList.add('bg-zinc-300', 'text-zinc-700');
        gridViewContainer.classList.remove('hidden');
        listViewContainer.classList.add('hidden');
    });

    listViewBtn.addEventListener('click', () => {
        listViewBtn.classList.remove('bg-zinc-300', 'text-zinc-700');
        listViewBtn.classList.add('bg-red-500', 'text-white');
        gridViewBtn.classList.remove('bg-red-500', 'text-white');
        gridViewBtn.classList.add('bg-zinc-300', 'text-zinc-700');
        listViewContainer.classList.remove('hidden');
        gridViewContainer.classList.add('hidden');
    });
}

function initializeSearchAndFilters() {
    console.log('Initializing search and filters');
    const searchInput = document.getElementById('search-input');
    
    if (!searchInput) {
        console.error('Search input not found');
        return;
    }

    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.report-card, .report-item');
        items.forEach(item => {
            const title = item.querySelector('h3').textContent.toLowerCase();
            item.style.display = title.includes(searchTerm) ? '' : 'none';
        });
    });
}

function filterReports(type) {
    console.log('Filtering reports:', type);
    const items = document.querySelectorAll('.report-card, .report-item');
    items.forEach(item => {
        if (type === 'all' || 
            (type === 'channel' && item.classList.contains('channel-report')) || 
            (type === 'video' && item.classList.contains('video-summary'))) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

function initializeModal() {
    console.log('Initializing modal');
    const closeModalButton = document.getElementById('close-modal');
    const reportModal = document.getElementById('report-modal');

    if (!closeModalButton || !reportModal) {
        console.error('Modal elements not found');
        return;
    }

    closeModalButton.addEventListener('click', () => {
        console.log('Close button clicked');
        closeModal();
    });

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && !reportModal.classList.contains('hidden')) {
            console.log('Escape key pressed');
            closeModal();
        }
    });

    reportModal.addEventListener('click', function(event) {
        if (event.target === reportModal) {
            console.log('Modal overlay clicked');
            closeModal();
        }
    });
}

function initializeReportCards() {
    console.log('Initializing report card click handlers');
    document.querySelectorAll('.report-card, .report-item').forEach(element => {
        element.addEventListener('click', function() {
            const type = this.classList.contains('channel-report') ? 'channel_report' : 'video_summary';
            const id = this.getAttribute('data-id');
            viewReport(type, id);
        });
    });
}

function closeModal() {
    console.log('Closing modal');
    const modal = document.getElementById('report-modal');
    if (modal) {
        modal.classList.add('hidden');
    } else {
        console.error('Modal element not found');
    }
}

function viewReport(type, id) {
    console.log(`Opening ${type} with ID: ${id}`);
    let url = type === 'channel_report' ? `/report/${id}` : `/summary/${id}`;
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const modalContent = document.getElementById('modal-content');
            const modal = document.getElementById('report-modal');
            
            if (!modalContent || !modal) {
                throw new Error('Modal elements not found');
            }
            
            if (type === 'channel_report') {
                displayReport(data, modalContent);
            } else {
                displaySummary(data, modalContent);
            }
            
            modal.classList.remove('hidden');

            initializeCopyButtons();
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Failed to load ${type}: ${error.message}`);
        });
}

function addCopyButtonsToModal() {
    const modal = document.getElementById('report-modal');
    if (modal) {
        modal.addEventListener('shown', initializeCopyButtons);
    }
}

function openNewItemModal() {
    console.log('Checking for new items to display');
    const urlParams = new URLSearchParams(window.location.search);
    const newReportId = urlParams.get('new_report');
    const newSummaryId = urlParams.get('new_summary');
    
    if (newReportId) {
        viewReport('channel_report', newReportId);
    } else if (newSummaryId) {
        viewReport('video_summary', newSummaryId);
    }
}

function createCopyButton() {
  return `
    <button class="copy-button absolute top-4 right-4 p-2 text-zinc-500 hover:text-zinc-700 transition-colors" 
            title="Copy to clipboard">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" 
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </button>`;
}

async function copyTextToClipboard(text) {
    if (!navigator.clipboard) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';  // Avoid scrolling to bottom
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.width = '2em';
        textArea.style.height = '2em';
        textArea.style.padding = '0';
        textArea.style.border = 'none';
        textArea.style.outline = 'none';
        textArea.style.boxShadow = 'none';
        textArea.style.background = 'transparent';
        
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            document.execCommand('copy');
            textArea.remove();
            return true;
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
            textArea.remove();
            return false;
        }
    }
    
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (err) {
        console.error('Failed to copy text:', err);
        return false;
    }
}

async function copyMarkdownToClipboard(type, id) {
    try {
        // Make request to markdown endpoint
        const response = await fetch(`/export/${type}/${id}/markdown`);
        if (!response.ok) throw new Error('Failed to fetch markdown');
        
        const markdown = await response.text();
        
        // Copy to clipboard
        const success = await copyTextToClipboard(markdown);
        
        // Find the copy markdown button and show feedback
        const button = document.querySelector('.copy-markdown-button');
        const originalText = button.innerHTML;
        
        if (success) {
            button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" 
                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
                     stroke-linejoin="round" class="inline-block mr-2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Copied!
            `;
        } else {
            button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" 
                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
                     stroke-linejoin="round" class="inline-block mr-2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Failed to copy
            `;
        }
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
        
    } catch (error) {
        console.error('Error copying markdown:', error);
        alert('Failed to copy markdown');
    }
}

function initializeCopyButtons() {
    document.querySelectorAll('.copy-button').forEach(button => {
        button.addEventListener('click', async (e) => {
            e.stopPropagation();
            const panel = button.closest('.report-panel');
            const content = panel.querySelector('.report-panel-content');
            
            // Use the new cleaning function
            const textToCopy = cleanTextContent(content);
            
            // Store original button content
            const originalHTML = button.innerHTML;
            
            // Try to copy the text
            let success = false;
            
            if (navigator.clipboard) {
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    success = true;
                } catch (err) {
                    console.error('Clipboard API failed:', err);
                    success = false;
                }
            }
            
            if (!success) {
                // Fallback method
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.top = '0';
                textArea.style.left = '0';
                textArea.style.width = '2em';
                textArea.style.height = '2em';
                textArea.style.padding = '0';
                textArea.style.border = 'none';
                textArea.style.outline = 'none';
                textArea.style.boxShadow = 'none';
                textArea.style.background = 'transparent';
                
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    success = document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                    success = false;
                }
                
                textArea.remove();
            }

            if (success) {
                // Show success feedback
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" 
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
                         stroke-linejoin="round" class="text-green-500">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                `;
                button.classList.add('text-green-500');
            } else {
                // Show error feedback
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" 
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
                         stroke-linejoin="round" class="text-red-500">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                `;
                button.classList.add('text-red-500');
            }
            
            // Reset after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('text-green-500', 'text-red-500');
            }, 2000);
        });
    });
}

function cleanTextContent(element) {
    // Get all text nodes and elements
    let text = '';
    const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT,
        null,
        false
    );

    let node;
    while (node = walker.nextNode()) {
        if (node.nodeType === Node.ELEMENT_NODE) {
            // Add line breaks for block elements and list items
            if (getComputedStyle(node).display === 'block' || 
                node.tagName === 'LI' || 
                node.tagName === 'P' || 
                node.tagName === 'DIV' ||
                node.tagName === 'H1' ||
                node.tagName === 'H2' ||
                node.tagName === 'H3' ||
                node.tagName === 'H4') {
                // Don't add line break at the start of the content
                if (text) {
                    text += '\n';
                }
            }
        } else if (node.nodeType === Node.TEXT_NODE) {
            // Clean up the text content
            const cleanText = node.textContent.trim();
            if (cleanText) {
                text += cleanText + ' ';
            }
        }
    }

    // Clean up extra spaces while preserving line breaks
    return text
        .replace(/[ \t]+/g, ' ')        // Replace multiple spaces/tabs with single space
        .replace(/\n\s+/g, '\n')        // Remove spaces at start of lines
        .replace(/\s+\n/g, '\n')        // Remove spaces at end of lines
        .replace(/\n\n+/g, '\n\n')      // Replace multiple line breaks with double line break
        .replace(/^\s+|\s+$/g, '');     // Trim start and end
}

function formatNumber(value) {
    // Handle invalid inputs
    if (value === null || value === undefined || value === '' || value === 'NaN' || Number.isNaN(value)) {
        return '0';  // or return 'N/A' if you prefer
    }
    
    // Convert string numbers to integers
    const number = typeof value === 'string' ? parseInt(value.replace(/[^0-9]/g, '')) : value;
    
    // Final check if conversion resulted in a valid number
    if (isNaN(number)) {
        return '0';  // or return 'N/A' if you prefer
    }
    
    return new Intl.NumberFormat('en-US').format(number);
}

/*
    -----------------
    DISPLAY FUNCTIONS
    -----------------
*/
function displayReport(data, container) {
    console.log('Displaying report:', data);
    const report = data.report;
    const raw_data = data.raw_channel_data;
    const categorization = data.categorization;

    let content = '';

    // Add export buttons
    content += `
        <div class="flex justify-end space-x-2 mb-4">
            <!-- a href="/export/report/${data.report_id}/pdf" 
               class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                Export PDF
            </a -->
            <button onclick="copyMarkdownToClipboard('report', ${data.report_id})" 
                    class="copy-markdown-button px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" 
                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
                     stroke-linejoin="round" class="inline-block mr-2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy as Markdown
            </button>
            <a href="/export/report/${data.report_id}/markdown"
               class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                Export Markdown
            </a>
        </div>
    `;

    if (raw_data) {
        const createTags = (items, bgColor) => items.slice(0, 3).map(item => 
            `<span class="inline-block ${bgColor} text-white text-xs px-2 py-1 rounded-full mx-1">${item}</span>`
        ).join('');

        const infoItems = [];
        if (raw_data.subscriber_count) {
            infoItems.push(`${formatNumber(raw_data.subscriber_count)} subscribers`);
        }
        if (raw_data.total_video_count) {
            infoItems.push(`${formatNumber(raw_data.total_video_count)} videos`);
        }
        
        if (categorization && categorization.content_categories.length > 0) {
            infoItems.push(`${createTags(categorization.content_categories, 'bg-blue-500')}`);
        }
        
        if (categorization && categorization.video_formats.length > 0) {
            infoItems.push(`${createTags(categorization.video_formats, 'bg-green-500')}`);
        }

        const infoString = infoItems.join(' • ');

        content += `
            <div class="mb-6">
                ${raw_data.banner_url ? `<img src="${raw_data.banner_url}=w2120-fcrop64=1,00005a57ffffa5a8-k-c0xffffffff-no-nd-rj" alt="Channel Banner" class="w-full h-32 object-cover rounded-t-lg">` : ''}
                <div class="bg-zinc-100 p-4 rounded-b-lg">
                    <div class="flex items-center">
                        ${raw_data.avatar_url ? `<img src="${raw_data.avatar_url}" alt="Channel Avatar" class="w-16 h-16 rounded-full mr-4">` : ''}
                        <div class="flex-grow">
                            <h2 class="text-2xl font-bold">${raw_data.title || 'Channel Report'}</h2>
                            <p class="text-zinc-600 text-sm mt-1 flex flex-wrap items-center">${infoString}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        let mostViewedVideo = null;
        if (raw_data.videos && raw_data.videos.length > 0) {
            mostViewedVideo = raw_data.videos.reduce((prev, current) => 
                (prev.views > current.views) ? prev : current
            );
        }

        content += `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h3 class="text-xl font-semibold mb-2">Channel Trailer</h3>
                    <div class="relative" style="padding-top: 56.25%;">
                        ${raw_data.trailer_video_id 
                            ? `<iframe src="https://www.youtube.com/embed/${raw_data.trailer_video_id}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="absolute top-0 left-0 w-full h-full"></iframe>`
                            : `<div class="absolute top-0 left-0 w-full h-full bg-zinc-200 flex items-center justify-center">No trailer available</div>`
                        }
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Most Viewed Recent Video</h3>
                    <div class="relative" style="padding-top: 56.25%;">
                        ${mostViewedVideo
                            ? `<iframe src="https://www.youtube.com/embed/${mostViewedVideo.youtube_video_id}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="absolute top-0 left-0 w-full h-full"></iframe>`
                            : `<div class="absolute top-0 left-0 w-full h-full bg-zinc-200 flex items-center justify-center">No video data available</div>`
                        }
                    </div>
                </div>
            </div>
        `;
    }

    content += `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">`;

    if (report && report.consultation_report && report.consultation_report.sections) {
        const sections = report.consultation_report.sections;
        
        content += `
            <div class="report-column">
                ${displaySection(sections[0], 'Executive Summary')}
                ${displaySection(sections[1], 'Key Metrics')}
                ${displaySection(sections[4], 'Recommendations')}
            </div>
            <div class="report-column">
                ${displaySection(sections[2], 'Trends')}
                ${displaySection(sections[3], 'Stylistic Approach')}
                ${displaySection(sections[5], 'Limitations', true)}
            </div>
        `;
    } else {
        content += `<p class="col-span-2 text-red-500">Error: Report data is incomplete or missing.</p>`;
    }

    content += `</div>`;

    container.innerHTML = content;
}

function displaySection(section, title, isSimple = false) {
    if (!section || !section.content) {
        return '';
    }

    let sectionContent = '';
    if (isSimple) {
        // For simple sections (like Limitations), render bullet points directly
        sectionContent = `
            <ul class="list-disc pl-5 space-y-2">
                ${Array.isArray(section.content) 
                    ? section.content.map(point => `
                        <li class="report-text">${point.replace(/^-\s*/, '')}</li>
                      `).join('')
                    : `<li class="report-text">${section.content}</li>`
                }
            </ul>`;
    } else {
        // For nested sections, handle each subsection's bullet points
        sectionContent = section.content[0].sections.map(subsection => `
            <div class="mb-6">
                <h4 class="font-semibold text-base lg:text-lg mb-3">${subsection.subtitle}</h4>
                <ul class="list-disc pl-5 space-y-2">
                    ${Array.isArray(subsection.content) 
                        ? subsection.content.map(point => `
                            <li class="report-text">${point.replace(/^-\s*/, '')}</li>
                          `).join('')
                        : `<li class="report-text">${subsection.content}</li>`
                    }
                </ul>
            </div>
        `).join('');
    }

    return `
        <div class="report-panel bg-zinc-100 p-4 rounded-lg relative">
            ${createCopyButton()}
            <h3 class="text-xl lg:text-2xl font-semibold mb-4">${title}</h3>
            <div class="report-panel-content">
                ${sectionContent}
            </div>
        </div>
    `;
}

function displaySummary(data, container) {
    const summary = data.summary;
    container.innerHTML = `
        <div class="flex justify-end space-x-2 mb-4">
            <!-- a href="/export/summary/${data.summary_id}/pdf"
               class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                Export PDF
            </a -->
            <button onclick="copyMarkdownToClipboard('summary', ${data.summary_id})" 
                    class="copy-markdown-button px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" 
                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
                     stroke-linejoin="round" class="inline-block mr-2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy as Markdown
            </button>
            <a href="/export/summary/${data.summary_id}/markdown"
               class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                Export Markdown
            </a>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div class="report-panel bg-zinc-100 p-4 rounded-lg mb-4">
                    <h3 class="text-xl lg:text-2xl font-semibold mb-4">Video</h3>
                    <div class="report-panel-content">
                        <div class="relative" style="padding-bottom: 56.25%;">
                            <iframe 
                                src="https://www.youtube.com/embed/${data.video_id}" 
                                frameborder="0" 
                                allow="autoplay; encrypted-media" 
                                allowfullscreen
                                class="absolute top-0 left-0 w-full h-full"
                            ></iframe>
                        </div>
                            <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                                <p class="report-text"><strong>Views:</strong> ${formatNumber(summary.video_views)}</p>
                                <p class="report-text"><strong>Likes:</strong> ${formatNumber(data.raw_data.like_count)}</p>
                                <p class="report-text"><strong>Comments:</strong> ${formatNumber(data.raw_data.comment_count)}</p>
                                <p class="report-text"><strong>Published:</strong> ${new Date(data.raw_data.date_published).toLocaleDateString()}</p>
                            </div>
                    </div>
                </div>
                ${displaySummarySection('Overview', `<p class="report-text">${summary.overview}</p>`)}
                ${displaySummarySection('Key Points', `
                    <ul class="list-disc pl-5 report-text">
                        ${summary.key_points.map(point => `
                            <li class="mb-2">
                                <strong>${point.point_title}</strong>: ${point.point_description}
                            </li>
                        `).join('')}
                    </ul>
                `)}
            </div>
            <div>
                ${displaySummarySection('Engagement', `<p class="report-text">${summary.engagement_analysis}</p>`)}
                ${displaySummarySection('Target Audience', `<p class="report-text">${summary.target_audience}</p>`)}
                ${displaySummarySection('Discourse', `<p class="report-text mb-2">${summary.discourse_summary}</p>
                    <ul class="list-disc pl-5 report-text">
                        ${summary.discourse_themes.map(theme => `
                            <li class="mb-2">
                                <strong>${theme.theme_title}</strong>: ${theme.theme_description}
                            </li>
                        `).join('')}
                    </ul>
                `)}
                ${displaySummarySection('Improvement Suggestions', `
                    <ul class="list-disc pl-5 report-text">
                        ${summary.improvement_suggestions.map(suggestion => `
                            <li class="mb-2">
                                <strong>${suggestion.improvement_title}</strong>: ${suggestion.improvement_description}
                            </li>
                        `).join('')}
                    </ul>
                `)}
            </div>
        </div>
    `;
}

function displaySummarySection(title, content) {
    return `
        <div class="report-panel bg-zinc-100 p-4 rounded-lg mb-4 relative">
            ${createCopyButton()}
            <h3 class="text-xl lg:text-2xl font-semibold mb-4">${title}</h3>
            <div class="report-panel-content">
                ${content}
            </div>
        </div>
    `;
}

</script>

{% endblock %}